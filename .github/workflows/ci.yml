name: MyVector CI

on:
  push:
    branches: [ "main", "feature/*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  mysql-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        mysql-version: ['8.0', '8.4']

    steps:
      - name: Checkout MyVector code
        uses: actions/checkout@v4

      - name: Set up MySQL Server
        uses: shogo82148/actions-setup-mysql@v1
        with:
          mysql-version: ${{ matrix.mysql-version }}

      - name: Install Build Dependencies
        run: sudo apt-get update && sudo apt-get install -y make gcc g++ libmysqlclient-dev

      - name: Build MyVector Plugin
        run: make

      - name: Install MyVector Plugin
        run: |
          # Find the plugin directory for the installed MySQL
          PLUGIN_DIR=$(mysql -e "SELECT @@plugin_dir;" -s -N)
          sudo cp myvector.so "$PLUGIN_DIR/"

      - name: Run MTR Test Suite
        run: |
          # The setup-mysql action adds MTR to the path
          mysql-test-run.pl --suite=myvector --verbose