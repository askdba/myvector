name: MyVector CI

on:
  push:
    branches: [ "main", "feature/*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Fast build job - builds plugin only
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - mysql-tag: 'mysql-8.0.40'
            mysql-version: '8.0'
          - mysql-tag: 'mysql-8.4.3'
            mysql-version: '8.4'

    steps:
    - name: Checkout MyVector Code
      uses: actions/checkout@v4
      with:
        path: myvector

    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libssl-dev \
          libncurses5-dev \
          pkg-config \
          bison \
          libtirpc-dev \
          libldap2-dev \
          libsasl2-dev \
          libudev-dev \
          libre2-dev \
          libcurl4-openssl-dev \
          libprotobuf-dev \
          protobuf-compiler

    - name: Cache MySQL Source
      id: cache-mysql
      uses: actions/cache@v4
      with:
        path: mysql-server
        key: mysql-source-${{ matrix.mysql-tag }}-v2

    - name: Clone MySQL Source
      if: steps.cache-mysql.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 --branch ${{ matrix.mysql-tag }} \
          https://github.com/mysql/mysql-server.git mysql-server

    - name: Cache Boost
      id: cache-boost
      uses: actions/cache@v4
      with:
        path: boost_cache
        key: boost-${{ matrix.mysql-tag }}-v2

    - name: Copy MyVector to Plugin Directory
      run: |
        mkdir -p mysql-server/plugin/myvector
        
        # Copy source files (flatten src/ directory into plugin dir)
        cp myvector/src/*.cc mysql-server/plugin/myvector/
        
        # Copy header files (flatten include/ directory into plugin dir)
        cp myvector/include/*.h mysql-server/plugin/myvector/
        cp myvector/include/*.i mysql-server/plugin/myvector/ 2>/dev/null || true
        
        # Copy CMakeLists.txt
        cp myvector/CMakeLists.txt mysql-server/plugin/myvector/
        
        # Verify files are in place
        echo "=== Plugin directory contents ==="
        ls -la mysql-server/plugin/myvector/

    - name: Configure MySQL Build
      run: |
        cd mysql-server
        mkdir -p bld && cd bld
        
        # Configure MySQL with minimal options for plugin build
        cmake .. \
          -DDOWNLOAD_BOOST=1 \
          -DWITH_BOOST=../../boost_cache \
          -DWITH_UNIT_TESTS=OFF \
          -DWITH_ROUTER=OFF \
          -DWITH_RAPID=OFF \
          -DWITH_NDB=OFF \
          -DWITH_NDBCLUSTER=OFF \
          -DWITH_EXAMPLE_STORAGE_ENGINE=OFF \
          -DCMAKE_BUILD_TYPE=Release

    - name: Build MyVector Plugin
      run: |
        cd mysql-server/bld
        
        # Build only the myvector plugin target
        make myvector -j$(nproc)

    - name: Verify Build
      run: |
        echo "=== Looking for built plugin ==="
        find mysql-server/bld -name "myvector*.so" 2>/dev/null
        
        # Check plugin output directory
        if [ -d "mysql-server/bld/plugin_output_directory" ]; then
          ls -la mysql-server/bld/plugin_output_directory/
        fi

    - name: Upload Plugin Artifact
      uses: actions/upload-artifact@v4
      with:
        name: myvector-mysql${{ matrix.mysql-version }}-linux
        path: mysql-server/bld/plugin_output_directory/myvector.so
        if-no-files-found: warn

  # Quick syntax/lint check (doesn't require full MySQL build)
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install cppcheck
      run: sudo apt-get update && sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,style,performance \
          --suppress=missingIncludeSystem \
          --error-exitcode=0 \
          -I include \
          src/

  # Integration test - loads plugin into running MySQL
  test:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up MySQL Server
      uses: shogo82148/actions-setup-mysql@v1
      with:
        mysql-version: '8.4'
        auto-start: true
        root-password: 'root'

    - name: Download Plugin Artifact
      uses: actions/download-artifact@v4
      with:
        name: myvector-mysql8.4-linux
        path: ./plugin

    - name: Install and Test Plugin
      env:
        MYSQL_PWD: root
      run: |
        # Find the MySQL socket (not mysqlx.sock)
        SOCKET_FILE=$(find /tmp -name "mysql*.sock" -not -name "mysqlx*" -type s 2>/dev/null | head -1)
        if [ -z "$SOCKET_FILE" ]; then
          # Try common socket locations
          for sock in /tmp/mysql.sock /var/run/mysqld/mysqld.sock /tmp/*/mysql.sock; do
            if [ -S "$sock" ]; then
              SOCKET_FILE="$sock"
              break
            fi
          done
        fi
        
        echo "=== Debug: Looking for MySQL sockets ==="
        find /tmp -name "*.sock" -type s 2>/dev/null || true
        ls -la /tmp/actions-setup-mysql-*/  2>/dev/null || true
        echo "Using socket: $SOCKET_FILE"
        
        # Connect with password and socket
        MYSQL_CMD="mysql -u root -S ${SOCKET_FILE:-/tmp/mysql.sock}"
        
        # Get plugin directory
        PLUGIN_DIR=$($MYSQL_CMD -e "SELECT @@plugin_dir;" -s -N)
        echo "Plugin directory: $PLUGIN_DIR"
        
        # Copy plugin to MySQL plugin directory
        sudo cp ./plugin/myvector.so "$PLUGIN_DIR/"
        sudo chmod 755 "$PLUGIN_DIR/myvector.so"
        
        # Verify plugin file exists
        ls -la "$PLUGIN_DIR/myvector.so"
        
        # Install the plugin
        $MYSQL_CMD -e "INSTALL PLUGIN myvector SONAME 'myvector.so';"
        
        # Verify plugin is loaded
        $MYSQL_CMD -e "SELECT PLUGIN_NAME, PLUGIN_STATUS FROM information_schema.PLUGINS WHERE PLUGIN_NAME = 'myvector';"
        
        # Register UDFs (required for the plugin to expose functions)
        echo "=== Registering UDFs ==="
        $MYSQL_CMD -e "CREATE FUNCTION myvector_construct RETURNS STRING SONAME 'myvector.so';"
        $MYSQL_CMD -e "CREATE FUNCTION myvector_display RETURNS STRING SONAME 'myvector.so';"
        $MYSQL_CMD -e "CREATE FUNCTION myvector_distance RETURNS REAL SONAME 'myvector.so';"
        $MYSQL_CMD -e "CREATE FUNCTION myvector_is_valid RETURNS INTEGER SONAME 'myvector.so';"
        
        # Run basic UDF tests
        echo "=== Testing myvector_construct UDF ==="
        $MYSQL_CMD -e "SELECT LENGTH(myvector_construct('[1.0, 2.0, 3.0]'));"
        
        echo "=== Testing myvector_display UDF ==="
        $MYSQL_CMD -e "SELECT myvector_display(myvector_construct('[1.0, 2.0, 3.0]'));"
        
        echo "=== Testing myvector_distance UDF ==="
        $MYSQL_CMD -e "SELECT myvector_distance(myvector_construct('[1.0, 2.0, 3.0]'), myvector_construct('[4.0, 5.0, 6.0]'), 'L2');"
        
        echo "=== Testing myvector_is_valid UDF ==="
        $MYSQL_CMD -e "SELECT myvector_is_valid(myvector_construct('[1.0, 2.0, 3.0]'), 3);"
        
        echo "=== All basic tests passed! ==="
