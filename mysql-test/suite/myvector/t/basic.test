--source include/have_log_bin.inc

# Setup environment
--disable_query_log
let $MYVECTOR_VARDIR = `select @@datadir`;
let $MYVECTOR_CONFIG = `select @@myvector_config_file`;
let $MYVECTOR_IDXDIR = `select @@myvector_index_dir`;

--mkdir $MYVECTOR_IDXDIR

# Create a mock config file
--write_file $MYVECTOR_CONFIG
myvector_user_id=root
myvector_user_password=
myvector_socket=@MYSQLTEST_VARDIR/tmp/mysqld.1.sock
EOF

--enable_query_log

# Install plugin
# Note: SONAME depends on the platform, MTR usually handles .so/.dylib mapping if in plugin-dir
# But we might need to specify the path if not in default plugin-dir.
# For local testing, we assume it's build and reachable.
--replace_result .dylib .so
eval INSTALL PLUGIN myvector SONAME 'myvector.so';

# Source the registration script (need to be careful with paths)
# We'll manually register for now to keep it simple and hermetic in the test
CREATE FUNCTION myvector_construct RETURNS STRING SONAME 'myvector.so';
CREATE FUNCTION myvector_display   RETURNS STRING SONAME 'myvector.so';
CREATE FUNCTION myvector_distance  RETURNS REAL   SONAME 'myvector.so';

# Test myvector_construct
SELECT myvector_display(myvector_construct('[1.0, 2.0, 3.0]')) as vec;

# Test myvector_distance
SELECT myvector_distance(myvector_construct('[1.0, 0.0]'), myvector_construct('[0.0, 1.0]'), 'L2') as dist_l2;
SELECT myvector_distance(myvector_construct('[1.0, 0.0]'), myvector_construct('[0.0, 1.0]'), 'COSINE') as dist_cosine;

# Cleanup
DROP FUNCTION myvector_construct;
DROP FUNCTION myvector_display;
DROP FUNCTION myvector_distance;
UNINSTALL PLUGIN myvector;

--remove_file $MYVECTOR_CONFIG
--force-rmdir $MYVECTOR_IDXDIR
